<!DOCTYPE html>
   <html lang="en">
      <head>
         <meta charset="utf-8">
         <title>D3 Test</title>
         <script type="text/javascript" src="d3/d3.js"></script>
         <style type="text/css">
            svg {
               background-color: aliceblue;
            }
         </style>
      </head>
      <body>
         <script type="text/javascript">
            var dataset = [
            {  
               "fixed_asset":100,
               "current_asset":150,
               "equity": -50,
               "long-term_liabilities":80,
               "short-term_liabilities":170,
               "revenue":400,
               "operating_income":150,
               "ibit":100,
               "net_income":35
            },
            {  
               "fixed_asset":300,
               "current_asset":200,
               "equity":300,
               "long-term_liabilities":80,
               "short-term_liabilities":120,
               "revenue":300,
               "operating_income":150,
               "ibit":100,
               "net_income":35
            }            
            ];

            var w = 400;
            var h = 300;

            var svg = d3.select("body")
                        .append("svg")
                          .attr("width", w)
                          .attr("height", h);

            var padding_left = 20;
            var padding_bottom = 30;
            var padding_top = 10;

            var bs_width = 30;
            var revenue_width = 50;
            var padding_between_types = 15;
            var padding_between_data = 25;

            var data_width = bs_width * 2 + padding_between_types + revenue_width;

            var scaleY = d3.scale.linear();
            var domainMin = d3.min(dataset, function(d){ return Math.min(0, d["equity"], d["operating_income"]  , d["ibit"], d["net_income"])});
            var domainMax = d3.max(dataset, function(d){ return Math.max(d["current_asset"] + d["fixed_asset"], d["revenue"], d["operating_income"]  , d["ibit"], d["net_income"])});
            console.log(domainMin, domainMax)
            scaleY.domain([0, domainMax - domainMin]);
            scaleY.range([0, h - padding_bottom - padding_top]);

            var eS = svg.selectAll("rect")
               .data(dataset)
               .enter();

            eS
               .append("rect")
               .attr("class", "fixed_asset")
               .attr("fill", "lightskyblue")
               .attr("x", function(d, i){return padding_left + i * (data_width + padding_between_data);})
               .attr("y", function(d){return h - padding_bottom - scaleY(d["fixed_asset"] - domainMin);})
               .attr("width", bs_width)
               .attr("height", function(d){return scaleY(d["fixed_asset"]);});

            eS
               .append("rect")
               .attr("class", "current_asset")
               .attr("fill", "royalblue")
               .attr("x", function(d, i){return padding_left + i * (data_width + padding_between_data);})
               .attr("y", function(d){return h - padding_bottom - scaleY(d["fixed_asset"] + d["current_asset"] - domainMin) ;})
               .attr("width", bs_width)
               .attr("height", function(d){return scaleY(d["current_asset"]);});


            eS
               .append("rect")
               .attr("class", "long-term_liabilities")
               .attr("fill", "lightpink")
               .attr("x", function(d, i){return padding_left + i * (data_width + padding_between_data) + bs_width;})
               .attr("y", function(d){return h - padding_bottom- scaleY( Math.max(0, d["equity"]) + d["long-term_liabilities"] - domainMin) ;})
               .attr("width", bs_width)
               .attr("height", function(d){return scaleY(d["long-term_liabilities"]);});

            eS
               .append("rect")
               .attr("class", "short-term_liabilities")
               .attr("fill", "tomato")
               .attr("x", function(d, i){return padding_left + i * (data_width + padding_between_data) + bs_width;})
               .attr("y", function(d){return h - padding_bottom - scaleY( Math.max(0, d["equity"]) + d["long-term_liabilities"] + d["short-term_liabilities"] - domainMin);})
               .attr("width", bs_width)
               .attr("height", function(d){return scaleY(d["short-term_liabilities"]);});

            eS
               .append("rect")
               .attr("class", "revenue")
               .attr("fill", "gold")
               .attr("x", function(d, i){return padding_left + i * (data_width + padding_between_data) + bs_width * 2 + padding_between_types;})
               .attr("y", function(d){return h - padding_bottom - scaleY(d["revenue"] - domainMin);})
               .attr("width", revenue_width)
               .attr("height", function(d){return scaleY(d["revenue"]);});               

            eS
               .append("rect")
               .attr("class", "operating_income")
               .attr("fill", "greenyellow")
               .attr("x", function(d, i){return padding_left + i * (data_width + padding_between_data) + bs_width * 2 + padding_between_types;})
               .attr("y", function(d){return h - padding_bottom - scaleY(d["operating_income"] - domainMin) ;})
               .attr("width", revenue_width * 0.7)
               .attr("height", function(d){return scaleY(d["operating_income"]);});               

            eS
               .append("rect")
               .attr("class", "ibit")
               .attr("fill", "limegreen")
               .attr("x", function(d, i){return padding_left + i * (data_width + padding_between_data) + bs_width * 2 + padding_between_types;})
               .attr("y", function(d){return h - padding_bottom- scaleY(d["ibit"] - domainMin);})
               .attr("width", revenue_width * 0.5)
               .attr("height", function(d){return scaleY(d["ibit"]);});

            eS
               .append("rect")
               .attr("class", "net_income")
               .attr("fill", "lime")
               .attr("x", function(d, i){return padding_left + i * (data_width + padding_between_data) + bs_width * 2 + padding_between_types;})
               .attr("y", function(d){return h - padding_bottom -scaleY(d["net_income"] - domainMin);})
               .attr("width", revenue_width * 0.3)
               .attr("height", function(d){return scaleY(d["net_income"]);});

            eS
               .append("rect")
               .attr("class", "equity")
               .attr("fill", "lightgreen")
               .attr("x", function(d, i){return padding_left + i * (data_width + padding_between_data) + bs_width;})
               .attr("y", function(d){return h - padding_bottom - scaleY(Math.max(d["equity"], 0) - domainMin) ;})
               .attr("width", bs_width)
               .attr("height", function(d){
                  console.log(Math.abs(d["equity"]));
                  console.log(scaleY(Math.abs(d["equity"])));
                  return scaleY(Math.abs(d["equity"]));});

         </script>
</html>
